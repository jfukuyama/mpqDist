---
title: "Simulation examples for MPQ distances"
output: tufte::tufte_html
toc: false
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE
)
```


# Setup

```{r}
library(ape)
library(mpqDist)
library(plotly)
library(phyloseq)
library(tidyverse)
library(viridis)
library(phangorn)
library(patchwork)
library(treeDA)
library(ggbrace)
library(vegan)
library(picante)
set.seed(0)
data(gentry)
gentry
```

# Simulations

We're going to test whether our null means and variances look right.
To do this, we will generate "OTU tables" that are independent normal random variables, with potentially different standard deviations.
We'll use the gentry data as a skeleton (same tree, same number of samples and sites, same standard deviations for the species when we look into changing standard deviations).
```{r}
sim_homo = gentry
sim_hetero = gentry
n = nsamples(gentry)
p = ntaxa(gentry)
sds = apply(log(1 + otu_table(gentry)), 2, sd)
sim_homo_matrix = matrix(rnorm(n = n * p), nrow = n, ncol = p)
rownames(sim_homo_matrix) = sample_names(gentry)
colnames(sim_homo_matrix) = taxa_names(gentry)
sim_hetero_matrix = sweep(sim_homo_matrix, MARGIN = 2, STATS = sds, FUN = '*')
otu_table(sim_homo) = otu_table(sim_homo_matrix, taxa_are_rows = FALSE)
otu_table(sim_hetero) = otu_table(sim_hetero_matrix, taxa_are_rows = FALSE)
```

## Homoskedastic case

For the first simulation, we are 

```{r}
base_sample = 1
nmv = get_null_mean_and_variance(sim_homo)
mpq_distances = get_mpq_distances(otu_table(sim_homo), phy_tree(sim_homo))
animation_df = make_animation_df(mpq_distances, get_avg_distances_to_set, means_and_vars = nmv, base_sample, sample_data(sim_homo))
p = ggplot(aes(x = Lat, y = avg_dist, color = Elev), data = animation_df) +
    geom_point(aes(frame = frame)) +
    geom_hline(aes(yintercept = null_mean, frame = frame)) +
    geom_hline(aes(yintercept = null_mean - 2 * null_sd, frame = frame)) +
    geom_hline(aes(yintercept = null_mean + 2 * null_sd, frame = frame)) +
    stat_smooth(aes(frame = frame), se = FALSE) +
    scale_x_reverse() +
    scale_color_viridis()
ggplotly(p)

p = ggplot(aes(x = Lat, y = avg_dist, color = Elev), data = animation_df) +
    geom_point(aes(frame = frame)) +
    geom_hline(aes(yintercept = median, frame = frame)) +
    geom_hline(aes(yintercept = upper, frame = frame)) +
    geom_hline(aes(yintercept = lower, frame = frame)) +
    stat_smooth(aes(frame = frame), se = FALSE) +
    scale_x_reverse() +
    scale_color_viridis()
ggplotly(p)
```


## Heteroskedastic case


```{r}
base_sample = 1
nmv = get_null_mean_and_variance(sim_hetero)
mpq_distances = get_mpq_distances(otu_table(sim_hetero), phy_tree(sim_hetero))
animation_df = make_animation_df(mpq_distances, get_avg_distances_to_set, means_and_vars = nmv, base_sample, sample_data(sim_hetero))
p = ggplot(aes(x = Lat, y = avg_dist, color = Elev), data = animation_df) +
    geom_point(aes(frame = frame)) +
    geom_hline(aes(yintercept = null_mean, frame = frame)) +
    geom_hline(aes(yintercept = null_mean - 2 * null_sd, frame = frame)) +
    geom_hline(aes(yintercept = null_mean + 2 * null_sd, frame = frame)) +
    stat_smooth(aes(frame = frame), se = FALSE) +
    scale_x_reverse() +
    scale_color_viridis()
ggplotly(p)


p = ggplot(aes(x = Lat, y = avg_dist, color = Elev), data = animation_df) +
    geom_point(aes(frame = frame)) +
    geom_hline(aes(yintercept = median, frame = frame)) +
    geom_hline(aes(yintercept = upper, frame = frame)) +
    geom_hline(aes(yintercept = lower, frame = frame)) +
    stat_smooth(aes(frame = frame), se = FALSE) +
    scale_x_reverse() +
    scale_color_viridis()
ggplotly(p)
```

## Non-null distributions


The two-gradient simulation described in the paper:
```{r}
make_anticorrelated_noise <- function(n, tr) {
    Q = vcv(tr)
    p = ncol(Q)
    Qeig = eigen(Q)
    D = Qeig$values
    D[1:(p/2)] = 0
    D = D / sum(D)
    D = diag(D)
    E = matrix(rnorm(n * p), nrow = n, ncol = p)
    E %*% sqrt(D) %*% t(Qeig$vectors)
}


set.seed(0)
p = 300
n = 25
tr = rtree(p)
alt = sample(c(-1, 1), n, replace = TRUE)
precip = sample(c(-1, 1), n, replace = TRUE)

phy_big = 1:p %in% Descendants(tr)[[469]]
phy_small_u = 1:p %in% Descendants(tr)[[503]]
phy_small_d = 1:p %in% Descendants(tr)[[529]]
M = .5 * outer(alt, phy_big) + outer(precip, phy_small_u) - outer(precip, phy_small_d)
X = M + rnorm(n = n * p, mean = 10, sd = .75) + p * .25 * make_anticorrelated_noise(n, tr)
colnames(X) = tr$tip.label
two_effect_sim = phyloseq(otu_table(X, taxa_are_rows = FALSE), phy_tree(tr), sample_data(data.frame(alt = alt, precip = precip)))
#nmv = get_null_mean_and_variance(two_effect_sim)
mpq_distances = get_mpq_distances(otu_table(two_effect_sim), phy_tree(two_effect_sim))
animation_df_alt = make_animation_df(mpq_distances, get_avg_distances_to_set,
                                     means_and_vars = nmv,
                                     base_sample = which.min(alt),
                                     sample_data(two_effect_sim))
animation_df_alt = animation_df_alt |>
    subset(avg_dist > 0) |>
    group_by(frame) |>
    mutate(p_val = wilcox.test(avg_dist ~ alt)$p.value, max_dist = max(avg_dist))
animation_df_precip = make_animation_df(mpq_distances,
                                        get_avg_distances_to_set,
                                        means_and_vars = nmv,
                                        base_sample = which.min(precip), sample_data(two_effect_sim))
animation_df_precip = animation_df_precip |>
    subset(avg_dist > 0) |>
    group_by(frame) |>
    mutate(p_val = wilcox.test(avg_dist ~ precip)$p.value, max_dist = max(avg_dist))
## p1 = ggplot(aes(x = factor(alt), y = avg_dist), data = animation_df_alt) +
##     geom_boxplot(aes(frame = frame))
## ggplotly(p1)

## p3 = ggplot(aes(x = factor(precip), y = avg_dist), data = animation_df_precip) +
##     geom_boxplot(aes(frame = frame))
## ggplotly(p3)
```


```{r}
math_labels <- c(
  "0" = "r = 0",
  "0.5" = "r = .5",
  "1" = "r = 1"
)
df_alt_label = subset(animation_df_alt, (frame %in% c(0,1) | (frame >= .49 & frame <= .51)) & avg_dist > 0)[,c("frame", "max_dist", "p_val")] |> unique()
df_alt_precip = subset(animation_df_precip, (frame %in% c(0,1) | (frame >= .49 & frame <= .51)) & avg_dist > 0)[,c("frame", "max_dist", "p_val")] |> unique()
p1 = ggplot(subset(animation_df_alt, (frame %in% c(0,1) | (frame >= .49 & frame <= .51)) & avg_dist > 0)) +
    geom_boxplot(aes(x = factor(alt), y = avg_dist)) +
    facet_wrap(~ as.factor(frame), scales = "free_y", labeller = labeller(.default = math_labels)) +
    scale_x_discrete(breaks = c(-1, 1), labels = c("low", "high")) +
    xlab("Altitude") +
    geom_label(aes(x = 1, y = max_dist + .2, label = paste0("p = ", signif(p_val, 3))),
               size = 3, label.padding = unit(.5, "lines"), label.size = 0,
              data = df_alt_label)
p2 = ggplot(subset(animation_df_precip, (frame %in% c(0,1) | (frame >= .49 & frame <= .51)) & avg_dist > 0)) +
    geom_boxplot(aes(x = factor(precip), y = avg_dist)) +
    facet_wrap(~ as.factor(frame), scales = "free_y", labeller = labeller(.default = math_labels)) +
    scale_x_discrete(breaks = c(-1, 1), labels = c("wet", "dry")) +
    xlab("Moisture") +
    geom_label(aes(x = 1, y = max_dist + .2, label = paste0("p = ", signif(p_val, 3))),
               size = 3, label.padding = unit(.5, "lines"), label.size = 0,
              data = df_alt_precip)
h_patch <- p1 / p2 & ylab(NULL) & theme(plot.margin = margin(5.5, 5.5, 5.5, 2))
#pdf("two-factor-sim.pdf", width = 6, height = 4)
wrap_elements(h_patch) +
  labs(tag = "MPQr distance to reference sample") +
  theme(
    plot.tag = element_text(size = rel(1), angle = 90),
    plot.tag.position = "left"
  )
#dev.off()
```

PERMANOVA version, with fewer samples:
```{r}
mpq_dist_list = get_mpq_distances(X, tr = tr, r = c(0, .5,1))[[1]]
adonis2(mpq_dist_list[[1]] ~ factor(alt), permutations = 9999)
adonis2(mpq_dist_list[[2]] ~ factor(alt), permutations = 9999)
adonis2(mpq_dist_list[[3]] ~ factor(alt), permutations = 9999)
adonis2(mpq_dist_list[[1]] ~ factor(precip), permutations = 9999)
adonis2(mpq_dist_list[[2]] ~ factor(precip), permutations = 9999)
adonis2(mpq_dist_list[[3]] ~ factor(precip), permutations = 9999)


```

Other metrics
```{r}
## phylosor
X_trunc = X
X_trunc[X < quantile(X, .5)] = 0
phylosor_sim = phylosor(X_trunc, tr) |> as.matrix()
phylosor_vs_alt = data.frame(dist = phylosor_sim[which.min(alt),],
                             alt = alt,
                             measure = "PhyloSor") |>
    subset(dist > 0)
phylosor_vs_precip = data.frame(dist = phylosor_sim[which.min(precip),],
                                precip = precip,
                                measure = "PhyloSor") |>
    subset(dist > 0)

## raosd
ultra_tr = chronos(tr, lambda = 1)
raod_dist = raoD(X, phy=ultra_tr)$H

raod_vs_alt = data.frame(dist = raod_dist[which.min(alt),],
                         alt = alt,
                         measure = "Rao's D") |>
    subset(dist > 0)
raod_vs_precip = data.frame(dist = raod_dist[which.min(precip),],
                            precip = precip,
                            measure = "Rao's D") |>
    subset(dist > 0)

## unifrac
uf_dist = UniFrac(phyloseq(otu_table(X_trunc, taxa_are_rows = FALSE), phy_tree(tr)), weighted = FALSE, normalized = TRUE, parallel = FALSE, fast = TRUE) |> as.matrix()
uf_vs_alt = data.frame(dist = uf_dist[which.min(alt),],
                       alt = alt,
                       measure = "UniFrac") |>
    subset(dist > 0)
uf_vs_precip = data.frame(dist = uf_dist[which.min(precip),],
                          precip = precip,
                          measure = "UniFrac") |> subset(dist > 0)

alternate_measures_alt = rbind(phylosor_vs_alt, raod_vs_alt, uf_vs_alt) |>
    mutate(measure = fct_relevel(factor(measure), 
                                 "PhyloSor", 
                                 "UniFrac", 
                                 "Rao's D")) |>
    group_by(measure) |>
    mutate(p_val = wilcox.test(dist ~ alt)$p.value, max_dist = max(dist))

df_2_alt_label = alternate_measures_alt[,c("p_val", "max_dist", "measure")] |> unique()

alternate_measures_precip = rbind(phylosor_vs_precip, raod_vs_precip, uf_vs_precip) |>
    mutate(measure = fct_relevel(measure, 
                                 "PhyloSor", 
                                 "UniFrac", 
                                 "Rao's D")) |>
    group_by(measure) |>
    mutate(p_val = wilcox.test(dist ~ precip)$p.value, max_dist = max(dist))
df_2_precip_label = alternate_measures_precip[,c("p_val", "max_dist", "measure")] |> unique()
p_alternate_alt = ggplot(alternate_measures_alt) +
    geom_boxplot(aes(x = factor(alt), y = dist)) +
    facet_wrap(~ measure, scales = "free_y") +
    scale_x_discrete(breaks = c(-1, 1), labels = c("low", "high")) +
    xlab("Altitude") +
    geom_label(aes(x = 1, y = max_dist, label = paste0("p = ", signif(p_val, 3))),
               size = 3, label.padding = unit(.5, "lines"), label.size = 0,
               data = df_2_alt_label)

p_alternate_precip = ggplot(alternate_measures_precip) +
    geom_boxplot(aes(x = factor(precip), y = dist)) +
    facet_wrap(~ measure, scales = "free_y") +
    scale_x_discrete(breaks = c(-1, 1), labels = c("wet", "dry")) +
    xlab("Moisture") +
    geom_label(aes(x = 1, y = max_dist, label = paste0("p = ", signif(p_val, 3))),
               size = 3, label.padding = unit(.5, "lines"), label.size = 0,
              data = df_2_precip_label)


h_patch <- p_alternate_alt / p_alternate_precip & ylab(NULL) & theme(plot.margin = margin(5.5, 5.5, 5.5, 2))
#pdf("two-factor-sim-alternate-measures.pdf", width = 6, height = 4)
wrap_elements(h_patch) +
  labs(tag = "Distance to reference sample") +
  theme(
    plot.tag = element_text(size = rel(1), angle = 90),
    plot.tag.position = "left"
  )
#dev.off()
```
